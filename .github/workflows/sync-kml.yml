name: Sync KML to GitHub Pages

on:
  schedule:
    - cron: "*/30 * * * *"   # Ejecuta cada 30 minutos (aj√∫stalo si quieres)
  workflow_dispatch:          # Permite ejecutarlo manualmente desde Actions

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout KML branch
        uses: actions/checkout@v4
        with:
          ref: KML

      - name: Set variables
        id: vars
        run: |
          # üëâ Cambia esta URL por tu fuente original real (si cambia el nombre, actualiza aqu√≠)
          echo "SRC_URL=https://www.wpc.ncep.noaa.gov/pwpf_72hr/kml/snow/prb_72hsnow_ge02_2026020412f072_40pct.kml" >> $GITHUB_OUTPUT

          # Nombre de destino con el que tambi√©n quieres conservar una copia fija (opcional)
          echo "DST_NAME=prb_72hsnow_ge02_2026020412f072_40pct.kml" >> $GITHUB_OUTPUT
          # Si prefieres versionado por timestamp, usa:
          # echo "DST_NAME=snow_$(date -u +'%Y%m%d%H%M%S').kml" >> $GITHUB_OUTPUT

      - name: Download & basic validate
        run: |
          set -euxo pipefail
          curl -fSL --max-time 60 "${{ steps.vars.outputs.SRC_URL }}" -o incoming.kml

          # Validaci√≥n m√≠nima de tama√±o (evita subir archivos vac√≠os o truncados)
          BYTES=$(wc -c < incoming.kml | tr -d ' ')
          echo "Bytes: $BYTES"
          if [ "$BYTES" -lt 200 ]; then
            echo "Archivo demasiado peque√±o. Abortando."
            exit 1
          fi

      - name: Write files (always refresh latest.kml)
        run: |
          set -euo pipefail
          DST="${{ steps.vars.outputs.DST_NAME }}"

          # Siempre sobrescribe el archivo de nombre fijo (si lo quieres conservar)
          cp incoming.kml "$DST"

          # Siempre actualiza el alias del √∫ltimo disponible
          cp incoming.kml latest.kml

      - name: Commit & push if changed
        run: |
          set -euo pipefail

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Agrega cambios (si los hay)
          git add -A

          # Solo commitea si hay diferencias indexadas
          if git diff --cached --quiet; then
            echo "No hay cambios para commitear (contenido id√©ntico)."
            exit 0
          else
            # (Opcional) marca la hora en el mensaje
            TS=$(date -u +'%Y-%m-%dT%H:%M:%SZ')
            git commit -m "Update KML ($TS)"
            git push origin KML
          fi
