name: Sync KML to GitHub Pages

on:
  schedule:
    - cron: "*/30 * * * *"   # Ejecuta cada 30 minutos (aj√∫stalo si quieres)
  workflow_dispatch:          # Permite ejecutarlo manualmente desde Actions

permissions:
  contents: write

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout KML branch
        uses: actions/checkout@v4
        with:
          ref: KML

      - name: Set variables
        id: vars
        run: |
          # üëâ Cambia esta URL por tu fuente original real
          echo "SRC_URL=https://www.wpc.ncep.noaa.gov/pwpf_72hr/kml/snow/prb_72hsnow_ge02_2026020412f072_40pct.kml" >> $GITHUB_OUTPUT

          # Nombre de destino en el branch KML (puede ser fijo o con timestamp)
          echo "DST_NAME=prb_72hsnow_ge02_2026020412f072_40pct.kml" >> $GITHUB_OUTPUT
          # Si prefieres versionar por fecha/hora, usa:
          # echo "DST_NAME=snow_$(date -u +'%Y%m%d%H%M%S').kml" >> $GITHUB_OUTPUT

      - name: Download & basic validate
        run: |
          set -euxo pipefail

          # Descarga del KML
          curl -fSL --max-time 60 "${{ steps.vars.outputs.SRC_URL }}" -o incoming.kml

          # Validaci√≥n m√≠nima de tama√±o (evita subir archivos vac√≠os o truncados)
          BYTES=$(wc -c < incoming.kml | tr -d ' ')
          echo "Bytes: $BYTES"
          if [ "$BYTES" -lt 200 ]; then
            echo "Archivo demasiado peque√±o. Abortando."
            exit 1
          fi

      - name: Skip if identical (avoid duplicate commit)
        id: dedup
        run: |
          set -euo pipefail
          DST="${{ steps.vars.outputs.DST_NAME }}"
          if [ -f "$DST" ]; then
            if cmp -s incoming.kml "$DST"; then
              echo "skip=true" >> $GITHUB_OUTPUT
              echo "El archivo ya existe sin cambios. Omitiendo commit."
              exit 0
            fi
          fi
          echo "skip=false" >> $GITHUB_OUTPUT

      - name: Commit file
        if: steps.dedup.outputs.skip == 'false'
        run: |
          set -euo pipefail
          DST="${{ steps.vars.outputs.DST_NAME }}"

          # Copia al destino y actualiza alias 'latest.kml'
          cp incoming.kml "$DST"
          cp incoming.kml latest.kml

          git config user.name  "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "$DST" latest.kml
          git commit -m "Update KML: $DST"
          git push origin KML
